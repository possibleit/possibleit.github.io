---
title: overlay
tags:
  - web
abbrlink: 20459
date: 2022-04-19 23:16:39
---

## 1. 什么是Overlay  
Overlay是指通过网络虚拟化技术，在同一张underlay网络上构建出一张或多张虚拟的逻辑网络。  
Underlay网络可以是二层也可以是三层网络。其中二层网络通常应用于以太网，通过VLAN进行划分。三层网络的典型应用就是互联网，其在同一个自治域[^1]使用OSPF、IS-IS等协议进行路由控制，在各个自治域之间则采用BGP等协议进行路由传递与互联。

<!-- more -->

然而传统的网络设备对数据包的转发都基于硬件，其构建而成的 Underlay 网络也产生了如下的问题：

- 由于硬件根据目的 IP 地址进行数据包的转发，所以传输的路径依赖十分严重。
- 新增或变更业务需要对现有底层网络连接进行修改，重新配置耗时严重。
- 互联网不能保证私密通信的安全要求。
- 网络切片和网络分段实现复杂，无法做到网络资源的按需分配。
- 多路径转发繁琐，无法融合多个底层网络来实现负载均衡。

相互连接的 Overlay 设备之间建立隧道，数据包准备传输出去时，设备为数据包添加新的 IP 头部和隧道头部，并且被屏蔽掉内层的 IP 头部，数据包根据新的 IP 头部进行转发。当数据包传递到另一个设备后，外部的 IP 报头和隧道头将被丢弃，得到原始的数据包，在这个过程中 Overlay 网络并不感知 Underlay 网络。

OverLay的网络协议：VXLAN，NVGRE，GRE，SST，NVO3，EVPN

## 2. VXLAN  

VXLAN 即虚拟扩展局域网，是大二层网络中广泛使用的网络虚拟化技术。在源网络设备与目的网络设备之间建立一条逻辑 VXLAN 隧道，采用 <font color=red> MAC in UDP（User Datagram Protocol） </font>封装方式，即，将虚拟机发出的原始以太报文完整的封装在 UDP 报文中，然后在外层使用物理网络的 IP 报文头和以太报文头封装，这样，封装后的报文就像普通 IP 报文一样，可以通过路由网络转发，这就像给二层网络的虚拟机插上了路由的翅膀，使虚拟机彻底摆脱了二、三层网络的结构限制。

>通俗来讲，就是两台计算机要在二层进行通信，但是计算机之间距离较远，中间联通的网络是三层的，因此把VXLAN报文添加一个UDP头，在三层网络传送，到达另一端时，去掉UDP头，表现出来的还是一个VXLAN报文。也就是说在三层网络上建立了一个隧道，把互联网看成了一个虚拟二层交换机。

![VXLAN.jpg](http://tva1.sinaimg.cn/large/006WUTFIgy1h1fhguhr0hj30vr0f5n4e.jpg =800x400)


#### VXLAN帧格式  
<img src="http://tva1.sinaimg.cn/mw690/006WUTFIgy1h1fhhfs9h3j30br05taaz.jpg"/>

- 从图中可以看到白色为原始报文（二层帧），包含了MAC头，IP头，传输层头部的报文，在原始报文之前进行了VXLAN的封装
对原始报文对封装顺序分别是：VXLAN头部，UDP头部，IP头部，MAC头部
- VXLAN头部：
    Flags 标志为
    VNI 24 位的VNI 字段，这也是vxlan 能支持千万租户的地方

- UDP头部：
    应用UDP通信双方是vtep 应用，其中目的端口就是接收方vtep 使用的端口，IANA 分配的端口是4789

- IP头部：
    主机之间通信的地址，可能是主机的网卡IP 地址，也可能是多播IP 地址

- MAC头部：
    主机之间通信的MAC 地址，源MAC 地址为主机MAC 地址，目的MAC 地址为下一跳设备的MAC 地址



[^1]: 什么是自治域